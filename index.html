<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é—®é“é•¿ç”Ÿ - ä»™ä¾ æ”¾ç½®</title>
    <link rel="stylesheet" href="css/mobile.css?v=9">
</head>
<body>
    <div class="game-wrap">
        <header class="header">
            <h1>é—®é“é•¿ç”Ÿ</h1>
            <div class="info-row">
                <div class="info-item" onclick="showTab('resource')"><div class="label">çµæ°”</div><div class="value" id="r-spirit">0</div></div>
                <div class="info-item" onclick="showTab('resource')"><div class="label">çµçŸ³</div><div class="value" id="r-stone">0</div></div>
                <div class="info-item" onclick="showTab('resource')"><div class="label">è¯æ</div><div class="value" id="r-herb">0</div></div>
                <div class="info-item" onclick="showTab('resource')"><div class="label">çŸ¿çŸ³</div><div class="value" id="r-ore">0</div></div>
            </div>
        </header>

        <nav class="nav">
            <button class="nav-btn active" data-tab="home" onclick="showTab('home')">é¦–é¡µ</button>
            <button class="nav-btn" data-tab="sect" onclick="showTab('sect')">å®—é—¨</button>
            <button class="nav-btn" data-tab="tech" onclick="showTab('tech')">åŠŸæ³•</button>
            <button class="nav-btn" data-tab="pet" onclick="showTab('pet')">çµå® </button>
            <button class="nav-btn" data-tab="resource" onclick="showTab('resource')">èµ„æº</button>
        </nav>

        <main class="content">
            <!-- é¦–é¡µ -->
            <section id="home-panel" class="panel active">
                <h2>ğŸ§˜ ä¿®ç‚¼</h2>
                <div class="card">
                    <h3>ğŸŒŸ å¢ƒç•Œ</h3>
                    <div class="big-text" id="realm-text">ç»ƒæ°”æœŸ ç¬¬1å±‚</div>
                    <div class="progress-bar"><div id="progress" class="progress-fill" style="width:0%"></div></div>
                    <p><span id="cultivation">0</span> / <span id="need">100</span></p>
                </div>
                <div class="card">
                    <h3>â›º é—­å…³ä¿®ç‚¼</h3>
                    <p>æ¯ç§’ +<span id="rate">1</span> çµæ°”</p>
                </div>
                <div class="card">
                    <h3>ğŸŒ¿ çµæ ¹</h3>
                    <div id="roots" class="roots-grid"></div>
                    <button class="btn btn-primary" style="width:100%;margin-top:10px;" onclick="upgradeRoot()">æå‡çµæ ¹</button>
                </div>
                <div class="card">
                    <h3>âš™ï¸ é˜Ÿåˆ— <span id="queue-info"></span></h3>
                    <div id="queue-display"></div>
                </div>
            </section>

            <!-- å®—é—¨ -->
            <section id="sect-panel" class="panel">
                <h2>ğŸ›ï¸ å®—é—¨</h2>
                <div class="card">
                    <h3>ğŸ‘¥ å¼Ÿå­: <span id="disciples">1</span> / <span id="max-disciples">5</span></h3>
                    <p style="font-size:0.8rem;color:#666;">æ¶ˆè€—: <span id="disciple-cost">10</span> çµæ°”/åˆ†</p>
                    <button class="btn btn-primary" style="margin-top:10px;" onclick="recruit()">æ‹›å‹Ÿå¼Ÿå­</button>
                </div>
                <div id="building-list"></div>
            </section>

            <!-- åŠŸæ³• -->
            <section id="tech-panel" class="panel">
                <h2>ğŸ“š åŠŸæ³•</h2>
                <div id="tech-list"></div>
            </section>

            <!-- çµå®  -->
            <section id="pet-panel" class="panel">
                <h2>ğŸ² çµå® </h2>
                <div class="card"><div id="my-pet" style="text-align:center;padding:20px;"><div style="font-size:3rem;">ğŸ¥š</div><p>æš‚æ— çµå® </p></div></div>
                <div class="card"><button class="btn btn-primary" style="width:100%;" onclick="catchPet()">ğŸ¯ æ•æ‰çµå® </button></div>
            </section>

            <!-- èµ„æº -->
            <section id="resource-panel" class="panel">
                <h2>ğŸ“¦ èµ„æºäº§å‡º</h2>
                <div class="card">
                    <div class="res-item"><span>çµæ°”</span><span>+<span id="p-spirit">0</span>/åˆ†</span></div>
                    <div class="res-item"><span>çµçŸ³</span><span>+<span id="p-stone">0</span>/åˆ†</span></div>
                    <div class="res-item"><span>è¯æ</span><span>+<span id="p-herb">0</span>/åˆ†</span></div>
                    <div class="res-item"><span>çŸ¿çŸ³</span><span>+<span id="p-ore">0</span>/åˆ†</span></div>
                </div>
                <div class="card">
                    <h3>ğŸ“œ å»ºç­‘å‡çº§</h3>
                    <p style="font-size:0.8rem;color:#888;">å‡çº§æ¶ˆè€—èµ„æºï¼Œæ—¶é—´å—å¼Ÿå­æ•°é‡å½±å“</p>
                </div>
            </section>
        </main>
    </div>

    <script>
    const REALMS = ['ç»ƒæ°”','ç­‘åŸº','é‡‘ä¸¹','å…ƒå©´','åŒ–ç¥','ç‚¼è™š','åˆä½“','å¤§ä¹˜','æ¸¡åŠ«','ä»™äºº'];
    const ELEMS = ['é‡‘','æœ¨','æ°´','ç«','åœŸ'];
    
    // å»ºç­‘é…ç½®
    const BUILDINGS = {
        train: {n:'ä¿®ç‚¼æ®¿', req:{é‡‘:3,æœ¨:3,åœŸ:3}, res:{stone:100}, time:30, desc:'æå‡çµæ°”äº§å‡º'},
        alchemy: {n:'ç‚¼ä¸¹æˆ¿', req:{æœ¨:2,ç«:3}, res:{stone:150,herb:50}, time:45, desc:'äº§å‡ºè¯æ'},
        forge: {n:'ç‚¼å™¨æ®¿', req:{é‡‘:2,ç«:3}, res:{stone:150,ore:50}, time:45, desc:'äº§å‡ºçŸ¿çŸ³'},
        park: {n:'çµå…½å›­', req:{æœ¨:2,åœŸ:3}, res:{stone:200,herb:30}, time:60, desc:'å¯æ•æ‰æ›´å¼ºçµå® '},
        array: {n:'æŠ¤å±±å¤§é˜µ', req:{é‡‘:3,æœ¨:3,æ°´:3,ç«:3,åœŸ:3}, res:{stone:500,ore:100}, time:120, desc:'å…¨å±æ€§åŠ æˆ'}
    };

    // åŠŸæ³•é…ç½®
    const TECHS = [
        {n:'å¼•æ°”è¯€', req:{level:1}, cost:{spirit:0}, time:10, eff:{spirit:0.1}, desc:'çµæ°”+10%'},
        {n:'èšçµæœ¯', req:{level:5,train:3}, cost:{spirit:500,stone:100}, time:30, eff:{spirit:0.2}, desc:'çµæ°”+20%'},
        {n:'é‡‘åˆšç½©', req:{level:3,array:1}, cost:{spirit:200,stone:50}, time:20, eff:{def:0.2}, desc:'é˜²å¾¡+20%'},
        {n:'çƒˆç„°æŒ', req:{level:5,forge:2}, cost:{spirit:300,ore:50}, time:25, eff:{atk:0.25}, desc:'æ”»å‡»+25%'},
        {n:'æ°´äº‘è¡£', req:{level:8,alchemy:3}, cost:{spirit:400,herb:100}, time:30, eff:{hp:0.3}, desc:'ç”Ÿå‘½+30%'},
        {n:'é’æœ¨åŠŸ', req:{level:10,train:5,park:2}, cost:{spirit:800,stone:200,herb:50}, time:45, eff:{spirit:0.3}, desc:'çµæ°”+30%'},
        {n:'ç´«é›·è¯€', req:{level:15,array:3}, cost:{spirit:1000,stone:300}, time:60, eff:{atk:0.5}, desc:'æ”»å‡»+50%'},
        {n:'åšåœŸç›¾', req:{level:12,train:5}, cost:{spirit:800,ore:100}, time:50, eff:{def:0.4}, desc:'é˜²å¾¡+40%'},
        {n:'ä¹è½¬çµè¯€', req:{level:20,train:8}, cost:{spirit:2000,stone:500}, time:90, eff:{spirit:0.5}, desc:'çµæ°”+50%'},
        {n:'å¤§é“ç»', req:{level:25,array:5}, cost:{spirit:5000,stone:1000}, time:180, eff:{all:0.3}, desc:'å…¨+30%'}
    ];

    const PETS = [
        {n:'é’è›‡',i:'ğŸ',a:5,b:[0,1,0,0,0],l:1},
        {n:'ç™½è™',i:'ğŸ¯',a:15,b:[2,0,0,1,0],l:5},
        {n:'é’é¾™',i:'ğŸ‰',a:30,b:[1,2,0,0,2],l:10},
        {n:'æœ±é›€',i:'ğŸ¦…',a:25,b:[0,1,1,2,0],l:8},
        {n:'ç„æ­¦',i:'ğŸ¢',a:10,b:[1,0,2,0,2],l:3},
        {n:'éº’éºŸ',i:'ğŸ¦„',a:50,b:[2,2,1,1,1],l:15}
    ];

    let game = {
        spirit:0, stone:0, herb:0, ore:0,
        realm:0, realmLv:1, cult:0,
        roots:[1,1,1,1,1], rootLv:1,
        buildings:{train:0,alchemy:0,forge:0,park:0,array:0},
        disciples:1, maxDisciples:5,
        tech:{}, techLevel:{},
        pet:null,
        queue:null, queueTime:0,
        lastSave:Date.now()
    };

    // åˆå§‹åŒ–
    function init(){
        game.tech[0]=true; // å¼•æ°”è¯€å…è´¹é€
        game.techLevel[0]=1;
    }

    function getNum(v){return Number(v)||0;}
    function getRoots(){return (game.roots||[1,1,1,1,1]).map(r=>getNum(r));}

    function load(){
        try{
            let d=localStorage.getItem('xianxia_v4');
            if(d){
                game={...game,...JSON.parse(d), buildings:game.buildings, tech:game.tech, techLevel:game.techLevel};
                // ä¿®å¤
                ['spirit','stone','herb','ore','realm','realmLv','cult','disciples'].forEach(k=>game[k]=getNum(game[k]));
                game.roots=getRoots();
                if(!game.buildings)game.buildings={train:0,alchemy:0,forge:0,park:0,array:0};
                if(!game.tech)game.tech={0:true};
                if(!game.techLevel)game.techLevel={0:1};
                
                let offline=(Date.now()-game.lastSave)/1000;
                if(offline>60){
                    let gain=getProd().spirit*offline*0.5;
                    game.spirit+=gain;
                    alert('ç¦»çº¿æ”¶ç›Š:+'+Math.floor(gain)+'çµæ°”');
                }
            }else init();
        }catch(e){init();}
    }

    function save(){game.lastSave=Date.now();localStorage.setItem('xianxia_v4',JSON.stringify(game));}

    // èµ„æºäº§å‡º
    function getProd(){
        let p={spirit:0,stone:0,herb:0,ore:0};
        // åŸºç¡€
        p.spirit=(game.realm+1)*game.realmLv;
        // å»ºç­‘äº§å‡º
        p.stone+=game.buildings.train*2;
        p.herb+=game.buildings.alchemy*5;
        p.ore+=game.buildings.forge*5;
        // çµæ ¹
        let roots=getRoots();
        p.spirit*=(1+roots.reduce((a,b)=>a+b,0)*0.1);
        // å¼Ÿå­
        p.spirit*=1+game.disciples*0.1;
        // åŠŸæ³•
        TECHS.forEach((t,i)=>{
            if(game.tech[i]){
                let lv=game.techLevel[i]||1;
                if(t.eff.spirit)p.spirit*=1+t.eff.spirit*lv;
                if(t.eff.all)p.spirit*=1+t.eff.all*lv;
            }
        });
        return p;
    }

    function getNeed(){return Math.floor(100*Math.pow(1.5,game.realmLv));}

    function getCombat(){
        let c=10+game.realm*50;
        if(game.pet)c+=game.pet.a*10;
        return c;
    }

    function canUpgrade(building){
        let b=BUILDINGS[building];
        let roots=getRoots();
        // æ£€æŸ¥çµæ ¹
        for(let e in b.req){
            let ei=ELEMS.indexOf(e);
            if(roots[ei]<b.req[e])return false;
        }
        return true;
    }

    function upgradeBuilding(type){
        if(game.queue)return;
        let b=BUILDINGS[type];
        // æ£€æŸ¥çµæ ¹
        if(!canUpgrade(type)){
            let req=[];
            for(let e in b.req)req.push(e+'çµæ ¹'+b.req[e]+'çº§');
            alert('éœ€è¦: '+req.join(','));
            return;
        }
        // æ£€æŸ¥èµ„æº
        let cost=b.res;
        if(game.stone<(cost.stone||0)||game.herb<(cost.herb||0)||game.ore<(cost.ore||0)){
            alert('èµ„æºä¸è¶³ï¼');
            return;
        }
        // æ‰£é™¤èµ„æº
        game.stone-=cost.stone||0;
        game.herb-=cost.herb||0;
        game.ore-=cost.ore||0;
        // å¼€å§‹å‡çº§
        game.queue=type;
        // æ—¶é—´å—å¼Ÿå­æ•°å½±å“
        game.queueTime=Math.max(5, b.time / (1+game.disciples*0.2));
        render();
    }

    function upgradeRoot(){
        let cost=Math.floor(10*Math.pow(1.5,game.rootLv));
        if(game.spirit>=cost){
            game.spirit-=cost;
            game.rootLv++;
            game.roots[Math.floor(Math.random()*5)]++;
        }
        render();
    }

    function recruit(){
        let cost=100*game.disciples;
        if(game.spirit>=cost && game.disciples<game.maxDisciples){
            game.spirit-=cost;
            game.disciples++;
            game.maxDisciples=5+Math.floor(game.buildings.train*0.5);
        }
        render();
    }

    function learnTech(i){
        if(game.tech[i]){
            // å‡çº§
            let t=TECHS[i];
            if(game.techLevel[i]>=10)return;
            let cost=Math.floor(t.cost.spirit*Math.pow(1.5,t.time)*game.techLevel[i]);
            if(game.spirit>=cost && !game.queue){
                game.spirit-=cost;
                game.queue='tech_'+i;
                game.queueTime=t.time;
            }
        }else{
            // å­¦ä¹ 
            let t=TECHS[i];
            // æ£€æŸ¥æ¡ä»¶
            if(game.realmLv<t.req.level){
                alert('å¢ƒç•Œä¸è¶³ï¼Œéœ€è¦'+t.req.level+'å±‚');
                return;
            }
            if(t.req.train && game.buildings.train<t.req.train){
                alert('ä¿®ç‚¼æ®¿ç­‰çº§ä¸è¶³');
                return;
            }
            // æ£€æŸ¥èµ„æº
            if(game.spirit<t.cost.spirit || game.stone<(t.cost.stone||0)){
                alert('èµ„æºä¸è¶³');
                return;
            }
            game.spirit-=t.cost.spirit;
            game.stone-=t.cost.stone||0;
            game.queue='tech_'+i;
            game.queueTime=t.time;
        }
        render();
    }

    function catchPet(){
        let reqLevel=1+game.buildings.park*2;
        if(game.spirit>=500 && !game.pet){
            game.spirit-=500;
            // æ ¹æ®çµå…½å›­ç­‰çº§è§£é”æ›´é«˜è´¨é‡çµå® 
            let available=PETS.filter(p=>p.l<=reqLevel);
            game.pet=available[Math.floor(Math.random()*available.length)];
            game.pet.lv=1;
        }
        render();
    }

    function showTab(t){
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
        document.querySelector('[data-tab="'+t+'"]').classList.add('active');
        document.getElementById(t+'-panel').classList.add('active');
    }

    function render(){
        document.getElementById('r-spirit').textContent=Math.floor(getNum(game.spirit));
        document.getElementById('r-stone').textContent=Math.floor(getNum(game.stone));
        document.getElementById('r-herb').textContent=Math.floor(getNum(game.herb));
        document.getElementById('r-ore').textContent=Math.floor(getNum(game.ore));
        
        document.getElementById('realm-text').textContent=REALMS[game.realm]+'æœŸ ç¬¬'+game.realmLv+'å±‚';
        let need=getNeed();
        document.getElementById('cultivation').textContent=Math.floor(getNum(game.cult));
        document.getElementById('need').textContent=need;
        document.getElementById('progress').style.width=(getNum(game.cult)/need*100)+'%';
        document.getElementById('rate').textContent=getProd().spirit.toFixed(1);
        
        let elems=ELEMS;
        let roots=getRoots();
        document.getElementById('roots').innerHTML=elems.map((e,i)=>
            '<span class="root '+(roots[i]>5?'active':'')+'">'+e+':'+roots[i]+'</span>'
        ).join('');
        
        document.getElementById('disciples').textContent=game.disciples;
        document.getElementById('max-disciples').textContent=game.maxDisciples;
        document.getElementById('disciple-cost').textContent=game.disciples*10;
        
        // é˜Ÿåˆ—
        if(game.queue){
            document.getElementById('queue-info').textContent='('+game.queueTime.toFixed(0)+'ç§’)';
            document.getElementById('queue-display').innerHTML='<div class="queue-item">å‡çº§ä¸­...</div>';
        }else{
            document.getElementById('queue-info').textContent='';
            document.getElementById('queue-display').innerHTML='<div class="queue-item" style="color:#666;">æ— é˜Ÿåˆ—</div>';
        }
        
        // å»ºç­‘
        let bHtml='';
        for(let k in BUILDINGS){
            let b=BUILDINGS[k];
            let lv=game.buildings[k];
            let can=canUpgrade(k);
            let reqs=[];
            for(let e in b.req)reqs.push(e+'çµæ ¹'+b.req[e]);
            let cost=[];
            if(b.res.stone)cost.push(b.res.stone+'çµçŸ³');
            if(b.res.herb)cost.push(b.res.herb+'è¯æ');
            if(b.res.ore)cost.push(b.res.ore+'çŸ¿çŸ³');
            
            bHtml+='<div class="card"><h3>'+b.n+' Lv.'+lv+'</h3>';
            bHtml+='<p style="font-size:0.8rem;color:#888;">'+b.desc+'</p>';
            bHtml+='<p style="font-size:0.75rem;color:#666;">éœ€è¦: '+reqs.join(',')+'</p>';
            bHtml+='<p style="font-size:0.75rem;color:#e94560;">æ¶ˆè€—: '+cost.join(',')+'</p>';
            bHtml+='<p style="font-size:0.75rem;color:#00d4ff;">æ—¶é—´: '+Math.max(5,b.time/(1+game.disciples*0.2)).toFixed(0)+'ç§’</p>';
            bHtml+='<button class="btn" style="margin-top:10px;" onclick="upgradeBuilding(\''+k+'\')" '+(can?'':'disabled')+'>'+(can?'å‡çº§':'çµæ ¹ä¸è¶³')+'</button></div>';
        }
        document.getElementById('building-list').innerHTML=bHtml;
        
        // åŠŸæ³•
        let tHtml='';
        TECHS.forEach((t,i)=>{
            let learned=game.tech[i];
            let lv=game.techLevel[i]||1;
            let reqs=[];
            if(t.req.level)reqs.push('å¢ƒç•Œ'+t.req.level);
            if(t.req.train)reqs.push('ä¿®ç‚¼æ®¿'+t.req.train);
            if(t.req.alchemy)reqs.push('ç‚¼ä¸¹æˆ¿'+t.req.alchemy);
            if(t.req.forge)reqs.push('ç‚¼å™¨æ®¿'+t.req.forge);
            if(t.req.park)reqs.push('çµå…½å›­'+t.req.park);
            if(t.req.array)reqs.push('æŠ¤å±±å¤§é˜µ'+t.req.array);
            
            tHtml+='<div class="card" onclick="learnTech('+i+')"><h3>'+t.n+' '+(learned?'Lv.'+lv:'')+'</h3>';
            tHtml+='<p style="font-size:0.8rem;color:#888;">'+t.desc+'</p>';
            if(!learned)tHtml+='<p style="font-size:0.75rem;color:#666;">éœ€è¦: '+reqs.join(',')+'</p>';
            tHtml+='<p style="font-size:0.75rem;color:#e94560;">'+(learned?(lv>=10?'æ»¡çº§':'å‡çº§:'+Math.floor(t.cost.spirit*Math.pow(1.5,t.time)*lv)+'çµæ°”'):'å­¦ä¹ :'+t.cost.spirit+'çµæ°”')+'</p></div>';
        });
        document.getElementById('tech-list').innerHTML=tHtml;
        
        // çµå® 
        if(game.pet){
            let pb=game.pet.b;
            document.getElementById('my-pet').innerHTML='<div style="font-size:3rem;">'+game.pet.i+'</div><p>'+game.pet.n+' Lv.'+game.pet.lv+'</p><p style="font-size:0.8rem;color:#888;">+'+(game.pet.a*game.pet.lv)+'æ”»å‡»</p>';
        }
        
        // èµ„æºäº§å‡º
        let prod=getProd();
        document.getElementById('p-spirit').textContent=prod.spirit.toFixed(1);
        document.getElementById('p-stone').textContent=prod.stone.toFixed(1);
        document.getElementById('p-herb').textContent=prod.herb.toFixed(1);
        document.getElementById('p-ore').textContent=prod.ore.toFixed(1);
        
        save();
    }

    // ä¸»å¾ªç¯
    setInterval(()=>{
        let prod=getProd();
        game.spirit+=prod.spirit/60;
        game.stone+=prod.stone/60;
        game.herb+=prod.herb/60;
        game.ore+=prod.ore/60;
        
        game.cult+=game.rootLv*0.1;
        if(getNum(game.cult)>=getNeed()){
            game.cult=0;
            if(game.realmLv<10)game.realmLv++;
            else if(game.realm<9){game.realm++;game.realmLv=1;}
        }
        
        // å¼Ÿå­æ¶ˆè€—
        game.spirit-=game.disciples*10/60;
        
        // é˜Ÿåˆ—
        if(game.queue){
            game.queueTime-=1/60;
            if(game.queueTime<=0){
                if(game.queue.startsWith('tech_')){
                    let i=parseInt(game.queue.split('_')[1]);
                    if(game.tech[i])game.techLevel[i]++;
                    else{game.tech[i]=true;game.techLevel[i]=1;}
                }else{
                    game.buildings[game.queue]++;
                }
                game.queue=null;
            }
        }
        
        render();
    },1000);

    setInterval(save,10000);
    load();
    </script>
</body>
</html>
